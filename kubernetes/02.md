마스터 노드와 워커 노드
클러스터의 구성 - 마스터 노드와 워커 노드

쿠버네티스는 전체적인 제어를 담당하는 마스터 노드와 실제 동작을 담당하는 워커 노드라는 두 가지 유형의 노드로 구성된다. 노드라는 낯선 용어가 있는데, 물리적 서버와 일치하는 개념이라고 할 수 있다.

마스터 노드에서 컨테이너를 실행하지는 않으며, 워커 노드에서 실행되는 컨테이너를 관리하는 역할. 

따라서 도커 엔진 같은 컨테이너 엔진도 설치되지 않는다. 

워커 노드는 실제 서버에 해당하는 부분으로, 컨테이너가 실제 동작하는 서버, 컨테이너가 동작해야 하므로 컨테이너 엔진이 설치되어야 하는 것은 당연.

마스터 노드와 워커 노드로 구성된 쿠버네티스 시스템을 클러스터라고 한다.

클러스터는 사람이 개입하지 않아도 마스터 노드에 설정된 내용에 따라 워커 노드가 관리되며 자율적으로 동작한다.

관리자는 마스터 노드의 초기 설정 후 가끔 조정만 하면 되며, 관리자가 직접 워커 노드를 관리하는 일도 없다.

마스터 노드에는 컨테이너 등의 상태를 관리하기 위해서 etcd라는 데이터베이스가 설치된다. 워커 노드에는 도커 엔진 같은 컨테이너 엔진이 필요하다.

마스터 노드를 설정하는 관리자의 컴퓨터에는 kubectl을 설치한다. 설치해야 마스터 노드에 로그인해 초기 설정을 진행하거나 추후 조정이 가능하다.

마스터 노드는 컨트롤 플레인을 통해 워커 노드를 관리한다.

컨트롤 플레인은 다섯 가지의 컴포넌트(부품)으로 구성된다. 

etcd 외에는 쿠버네티스에 포함되어 있다. etcd와 쿠버네티스만 설치하면 모든 설치가 완료된다.

마스터 노드측 컨트롤 플레인의 구성

kube-apiserver 외부와 통신하는 프로세스, kubectl로부터 명령을 전달받아 실행한다

kube-controller-manager 컨트롤러를 통합 관리, 실행한다

kube-scheduler 파드를 워커 노드에 할당한다.

cloud-controller-manager 클라우드 서비스와 연동해 서비스를 생성한다

etcd 클러스터 관련 정보 전반을 관리하는 데이터베이스

워커 노드에서는 kube-let과 kube-proxy가 동작한다. kube-let은 마스터 노드의 kube-scheduler와 연동하며 워커 노드에 컨테이너 또는 볼륨을 배치하고 실행한다. 이들 역시 쿠버네티스에 기본적으로 포함되어 있어 따로 설치할 필요는 없다.

워커 노드의 구성

kube-let 마스터 노드에 있는 kube-scheduler와 연동하며 워커 노드에 파드를 배치하고 실행한다. 또 실행 중인 파드의 상태를 정기적으로 모니터링하며 kube-scheduler에 통지한다.

kube-proxy 네트워크 통신의 라우팅 메커니즘

쿠버네티스는 항상 바람직한 상태를 유지한다.

쿠버네티스는 컨테이너를 생성하거나 삭제할 수 있지만 일일이 명령어를 입력하는 방식을 사용하지는 않는다.

바람직한 상태를 YAML 파일에 정의하고, 자동으로 컨테이너를 생성하거나 삭제하면서 이 상태로 만들고 유지하는 것이 쿠버네티스의 기본적인 아이디어다.

도커 컴포즈와 구별이 잘 가지 않을 수도 있지만 도커 컴포즈는 옵션을 지정해 수동으로 컨테이너의 수를 바꿀 수는 있어도 모니터링 기능이 없어서 컨테이너를 만들 때 외에는 관여하지 않는다. 쿠버네티스에는 상태를 유지하는 기능이 있다. 

컨테이너가 하나 망가지면 해당 컨테이너를 자동 삭제하고 새 컨테이너로 대체한다. 어떤 이유로 컨테이너가 망가졌다면 쿠버네티스가 알아서 망가진 컨테이너를 삭제하고 새 컨테이너로 대체한다. 

쿠버네티스를 사용하는 시스템에서 컨테이너 삭제

쿠버네티스의 기능은 어디까지나 자동으로 상태를 유지하는 것으로 컨테이너를 삭제하고 싶다면 삭제 명령어를 입력하는 것이 아니라 상태를 수정해야 한다.

물론 컨테이너 이므로 도커 명령어를 써서 컨테이너를 직접 삭제할 수도 있지만 컨테이너를 직접 삭제하면 쿠버네티스는 하나 부족하다는 것을 탐지하고 보충한다. 쿠버네티스 입장에서는 누군가가 일부러 컨테이너를 삭제한 것인지, 다른 이유로 컨테이너가 소멸한 것인지 구별할 수 없다. 

쿠버네티스의 목표는 바람직한 상태를 유지하는 것이다. 사람이 개입해서 컨테이너를 삭제해서는 안 된다.

컨테이너를 모두 삭제하고 싶다면 필요한 컨테이너 수가 0이라고 지정해주면 된다.

로드 밸런서와 클라우드 컴퓨팅

쿠버네티스는 똑같은 서버를 여러 대 갖춰야 하는 대규모 시스템을 전제로 하기 때문에 체감이 되지 않을 수 있다.

로드 밸런서라는 것을 알면 이해할 수 있을 것.

로드 밸런싱이란 한 대의 서버에 모든 요청이 집중되지 않도록 여러 대의 서버를 갖추고 요청을 각 서버에 분산하는 것을 말한다. 여러 개로 분산해 처리하는 편이 업무를 빠르게 처리할 수 있고, 한 곳에 과도한 업무가 집중되는 것을 막을 수 있다. 여러 대의 서버가 부하를 분담해 과도한 부하가 걸린 서버가 망가지거나 처리가 늦어지는 것을 방지한다.

서버에 각 나눠주는 역할을 로드 밸런서가 맡는다.

로드 밸런싱은 요청을 여러 대의 서버에 나눠주는 것을 말한다.

서버에 들어오는 요청은 많을 때도 있고, 적을 때도 있다. 대부분의 시스템은 요청이 많은 시기와 그렇지 않은 시기가 있다. 그렇다면 요청이 많을 때에 맞춰 갖춰 놓은 서버가 요청이 적을 때에는 그만큼 놀게 되기 때문에 비용이 낭비된다.

이 문제를 해결하는 것이 도커와 쿠버네티스이다. 부하에 맞춰 컨테이너를 늘리거나 줄일 수 있다면 놀고 있는 서버를 줄일 수 있다. 사용하지 않는 서버의 전원을 내리기만 해도 전기요금이 절약된다.

그러나 겨울에는 요청이 적으니 겨울에는 남는 서버를 끈다라는 식이면 모를까. 여름만 요청이 많으니 봄, 가을, 겨울은 남는 서버를 끈다.는 식이면 낭비를 줄였다고 하기 어렵다. 이를 해결해주는 것이 클라우드 컴퓨팅 서비스다.

구성에 따라 달라지지만 컨테이너 기술과 클라우드는 기본적으로 상성이 좋다. 자동으로 컨테이너를 늘리거나 줄이듯이 서버도 그렇게 할 수 있다.

서버를 쉽게 늘리거나 줄일 수 있는 구조를 확장성이 좋다고 표현한다. 국민의 대다수가 스마트폰을 가지고 어디서든 인터넷에 접속할 수 있는 환경에서는 서버에서 처리하는 요청의 수가 폭증하기 쉽기 때문에 확장성을 고려한 설계는 필수적이다.

etcd의 역할

도커 컴포즈와 쿠버네티스는 많은 차이점이 있지만 가장 큰 차이점은 쿠버네티스의 정의 파일(매니페스트 파일)이 데이터베이스로 관리된다는 점이다. 쿠버네티스가 정의 파일을 읽어들이면 그 내용은 etcd 데이터베이스에 저장된다.

파드는 이 정보를 근거로 관리되며, 도커 컴포즈와 또 다른 점은 쿠버네티스의 정의 파일은 커맨드로 수정이 가능하다는 점이다.

그러므로 쿠버네티스가 정의 파일을 읽어들인 후 커맨드로 직접 컨테이너에 손을 대면, 갖고 있는 정의 파일과 etcd에 저장된 정보가 일치하지 않게 된다. 운영에 규칙을 정하고 철저히 관리하자.