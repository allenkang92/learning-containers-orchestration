도커 컴포즈의 사용법

도커 컴포즈를 사용하려면 Dockerfile 스크립트로 이미지를 빌드할 때 처럼 호스트 컴퓨터에 폴더를 만들고 폴더에 정의 파일(YAML 파일)을 배치

정의 파일의 이름은 미리 정해진 docker-compose.yml이라는 이름을 사용해야 한다. 파일은 호스트 컴퓨터에 배치되지만 명령어는 똑같이 도커 엔진에 전달되며, 만들어진 컨테이너도 동일하게 도커 엔진 위에서 동작한다. 

사람이 일일이 입력하던 명령어를 도커 컴포즈가 대신 입력해주는 역할을 하는 구조

정의 파일은 한 폴더에 하나만 있을 수 있다.

여러 개의 정의 파일을 사용하려면 그 개수만큼 폴더를 만들어야 한다. 컨테이너 생성에 필요한 이미지 파일 등 컴포즈가 사용할 폴더에 함께 준다.

도커 컴포즈에서 컨테이너가 모인 것을 서비스라고 부른다.

도커 컴포즈 파일을 작성하는 법

도커 컴포즈는 컴포즈 파일을 그대로 실행하는 역할을 하므로 컴포즈 파일이 반드시 필요

정의 파일은 YAML 형식을 따른다. 파일의 확장자는 .yml이다. 

파일 이름은 docker-compose.yml이라고 짓는다. -f 옵션을 사용해 파일 이름을 지정하면 다른 이름을 사용해도 되지만 그렇지 않다면 정해진 이름을 사용해야 한다.

컴포즈 파일은 맨 앞에 컴포즈 버전을 적고, 그 뒤로 services와 networks, volumes를 차례로 기재

services는 컨테이너에 대한 내용. 도커 컴포즈와 쿠버네티스에서는 컨테이너의 집합체를 서비스라고 부른다.

작성 요령은 주 항목 → 이름 추가 → 설정과 같은 순서

주 항목은 services, networks, volumes 등이 있음. 주 항목 아래에는 이름을 기재한다. 컨테이너는 컨테이너 이름, 네트워크는 네트워크 이름, 볼륨은 볼륨 이름을 기재하면 된다.

이때 이름은 주 항목보다 한 단 들여쓰기해서 적는다. 한 단의 공백 개수는 몇 개여도 상관 없지만 탭은 사용할 수 없다. 공백 동일하게 사용. YAML 형식에서는 공백에 따라 의미가 달라지므로 탭은 의미가 없음. 

이름 뒤에는 반드시 콜론(:)을 붙인다. 해당 줄에 이어서 설정을 기재하려면 콜론 뒤로 공백이 하나 있어야 한다. 이 자리에 공백을 넣는 것을 잊어버리기 쉽기 때문에 오류가 발생한다면 여기부터 확인하는 것이 좋다

여러 항목이 있다면 같은 들여쓰기로 기재

컴포즈 파일의 작성 예

version: “3”

services:

컨테이너_이름1:

컨테이너_이름2: 

networks:

네트워크_이름1:

volumes:

볼륨_이름1:

볼륨_이름2:

이름을 기재한 다음에는 각 컨테이너의 설정을 기재한다. 기재할 내용이 한 가지라면 콜론 뒤에 이어 적으면 되지만(사이에 공백을 잊지 말고 넣는다) 내용이 여러 개라면 줄을 바꿔 하이픈(-)을 앞에 적고 들여쓰기를 맞춘다.

앞에서 이름을 적을 때 들여쓰기 한 단을 공백 두개로 했다면 공백 두개를 더 들여써야 한다. 주 항목과 비교하면 공백 네 개를 들여쓴 셈

또 줄을 바꿔 하이픈을 앞에 적은 행은 다시 공백 두 개를 들여쓴다. 주 항목과 비교하면 공백 여섯 개가 된다.

컴포즈 파일 작성 요령 

첫 줄에 도커 컴포즈 버전을 기재

주 항목 services, networks, volumes 아래에 설정 내용을 기재

항목 간의 상하 관계는 공백을 사용한 들여쓰기로 나타낸다

들여쓰기는 같은 수의 배수 만큼의 공백을 사용한다

이름은 주 항목 아래에 들여쓰기 한다음 기재한다

컨테이너 설정 내용은 이름 아래에 들여쓰기한 다음 기재한다

여러 항목을 기재하려면 줄 앞에 ‘-’을 붙인다.

이름 뒤에는 콜론(:)을 붙인다

콜론 뒤에는 반드시 공백이 와야 한다.(바로 줄바꿈 하는 경우는 예외)

“#” 뒤에 내용은 주석으로 간주된다.

문자열은 작은따옴표 또는 큰따옴표로 감싸 작성한다.

컴포즈 파일의 항목

주 항목(복수형이니 주의)

services

컨테이너를 정의

networks

네트워크를 정의

volumes 

볼륨을 정의

image

docker run 커맨드의 해당 옵션 또는 인자 : 이미지  인자

사용할 이미지를 지정

networks

docker run 커맨드의 해당 옵션 또는 인자 :  —net

접속할 네트워크를 지정

volumes

docker run 커맨드의 해당 옵션 또는 인자 : -v, —mount

스토리지 마운트를 설정

ports

docker run 커맨드의 해당 옵션 또는 인자 : -p

포트 설정

environment

docker run 커맨드의 해당 옵션 또는 인자 : -e

환경변수 설정

depends_on

docker run 커맨드의 해당 옵션 또는 인자 : 없음

다른 서비스에 대한 의존관계를 정의

restart

docker run 커맨드의 해당 옵션 또는 인자 : 없음

컨테이너 종료 시 재시작 여부를 설정

depends_on은 다른 서비스에 대한 의존관계를 나타낸다. 컨테이너를 생성하는 순서나 연동 여부를 정의.

컨테이너 생성 순서를 지정하는데 쓸 수 있다.

restart는 컨테이너 종료 시 재시작 여부를 설정

restart의 설정값

no 

재시작하지 않는다

always

항상 재시작한다

on-failure

프로세스가 0 외의 상태로 종료됐다면 재시작한다

unless-stopped 

종료 시 재시작하지 않음. 그외에는 재시작한다.

그외 정의항목

command

docker run 커맨드의 해당 옵션 또는 인자 : 커맨드 인자

컨테이너 시작 시 기존 커맨드를 오버라이드

container_name

docker run 커맨드의 해당 옵션 또는 인자 : —name

실행할 컨테이너의 이름을 명시적으로 지정

dns

docker run 커맨드의 해당 옵션 또는 인자 : —dns

DNS 서버를 명시적으로 지정

env_file

docker run 커맨드의 해당 옵션 또는 인자 : 없음

환경설정 정보를 기재한 파일을 로드

entrypoint

docker run 커맨드의 해당 옵션 또는 인자 : —entrypoint

컨테이너 시작 시 ENTRYPOINT 설정을 오버라이드

external_links

docker run 커맨드의 해당 옵션 또는 인자 : —link

외부 링크를 설정

extra_hosts

docker run 커맨드의 해당 옵션 또는 인자 : —add-host

외부 호스트의 IP 주소를 명시적으로 지정

logging

docker run 커맨드의 해당 옵션 또는 인자 : —log-driver

로그 출력 대상을 설정

network_mode

docker run 커맨드의 해당 옵션 또는 인자 : —network

네트워크 모드를 설정

컴포즈 파일

도커 컴포즈로 만든 컨테이너라도 도커 엔진을 통해 명령을 내릴 수 있다.

도커 엔진을 통해 내린 명령은 컴포즈 파일까지 반영이 되지 않는다

컴포즈 파일은 도커 컴포즈가 내용을 읽는 평범한 텍스트 파일에 불과함.